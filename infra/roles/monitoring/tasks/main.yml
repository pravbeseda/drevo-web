---
# Install Netdata using official kickstart script
- name: Download Netdata kickstart script
  get_url:
    url: https://my-netdata.io/kickstart.sh
    dest: /tmp/netdata-kickstart.sh
    mode: '0755'
  become: yes

- name: Run Netdata kickstart script
  shell: |
    /tmp/netdata-kickstart.sh --disable-telemetry
  args:
    creates: /usr/sbin/netdata
  become: yes

- name: Disable anonymous statistics
  file:
    path: /etc/netdata/.opt-out-from-anonymous-statistics
    state: touch
    mode: '0644'
  become: yes

- name: Ensure Netdata service is running and enabled
  systemd:
    name: netdata
    state: started
    enabled: yes

- name: Connect Netdata to cloud
  shell: |
    wget -O /tmp/netdata-claim.sh https://get.netdata.cloud/kickstart.sh && \
    sh /tmp/netdata-claim.sh \
    --stable-channel \
    --claim-token KB7oUWx-0-gLKBva91Bf9PKm_GiTD_8kuuo7Iwj9vyHP_5j0p5FDZrrRIjVNK50pc0IdOaYoUWCcUbH3po37ARWIa9DGvvhcW6A_HSCSDN-UhD_3rJh2Quh9Yd56IdIBJn83lXs \
    --claim-rooms fcd21f06-462a-4eff-bc19-5f1cd143c2f4 \
    --claim-url https://app.netdata.cloud
  become: yes
  register: claim_result
  changed_when: "'Claim succeeded!' in claim_result.stdout"
  failed_when: 
    - claim_result.rc != 0 
    - "'already claimed' not in claim_result.stderr"
