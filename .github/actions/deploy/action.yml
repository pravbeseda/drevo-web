name: 'Deploy to Server'
description: 'Deploy using SSH and rsync with verification'
author: 'Drevo CI/CD'

inputs:
  environment:
    description: 'Target environment (staging/production)'
    required: true
  ssh-private-key:
    description: 'SSH private key for deployment'
    required: true
  ssh-known-hosts:
    description: 'SSH known hosts'
    required: true
  ssh-user:
    description: 'SSH user for deployment'
    required: true
  ssh-host:
    description: 'SSH host for deployment'
    required: true
  ssh-port:
    description: 'SSH port for deployment'
    required: false
    default: '22'
  source-path:
    description: 'Source path to deploy from'
    required: true
    default: 'dist/apps/client'
  target-path:
    description: 'Target path on server (relative to user home)'
    required: true
  environment-url:
    description: 'Environment URL for notifications'
    required: false
  version:
    description: 'Release version (required parameter)'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Setup SSH for deployment
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ inputs.ssh-private-key }}
        known_hosts: ${{ inputs.ssh-known-hosts }}

    - name: Copy deployment scripts
      shell: bash
      run: |
        echo "üìù Copying deployment scripts..."
        scp -P ${{ inputs.ssh-port }} \
          scripts/deploy.sh scripts/ecosystem.config.js \
          ${{ inputs.ssh-user }}@${{ inputs.ssh-host }}:~/
        ssh -p ${{ inputs.ssh-port }} \
          ${{ inputs.ssh-user }}@${{ inputs.ssh-host }} \
          "chmod +x ~/deploy.sh"
        echo "‚úÖ Deployment scripts ready"

    - name: Create release directory
      shell: bash
      run: |
        echo "ÔøΩ Creating release directory for ${{ inputs.environment }}/${{ inputs.version }}..."
        ssh -p ${{ inputs.ssh-port }} \
          ${{ inputs.ssh-user }}@${{ inputs.ssh-host }} \
          "mkdir -p ~/releases/${{ inputs.environment }}/${{ inputs.version }}/"
        echo "‚úÖ Release directory created"

    - name: Deploy to ${{ inputs.environment }}
      shell: bash
      run: |
        echo "üöÄ Deploying to ${{ inputs.environment }} environment..."
        echo "üì¶ Version: ${{ inputs.version }}"
        
        # Deploy using rsync to versioned folder
        rsync -avz --delete \
          -e "ssh -p ${{ inputs.ssh-port }}" \
          ${{ inputs.source-path }}/ \
          ${{ inputs.ssh-user }}@${{ inputs.ssh-host }}:releases/${{ inputs.environment }}/${{ inputs.version }}/
        
        echo "‚úÖ Files deployed to versioned directory"

    - name: Execute deployment script
      shell: bash
      run: |
        echo "‚ö° Executing atomic deployment..."
        
        # Determine app name based on environment
        if [ "${{ inputs.environment }}" = "staging" ]; then
          APP_NAME="drevo-staging"
        elif [ "${{ inputs.environment }}" = "production" ]; then
          APP_NAME="drevo-production"
        else
          echo "‚ùå Invalid environment: ${{ inputs.environment }}"
          exit 1
        fi
        
        # Determine deployment path
        DEPLOY_PATH="~/releases/${{ inputs.environment }}-current"
        
        echo "üìã Deployment parameters:"
        echo "  - Environment: ${{ inputs.environment }}"
        echo "  - Version: ${{ inputs.version }}"
        echo "  - App Name: $APP_NAME"
        echo "  - Deploy Path: $DEPLOY_PATH"
        
        ssh -p ${{ inputs.ssh-port }} \
          ${{ inputs.ssh-user }}@${{ inputs.ssh-host }} \
          "~/deploy.sh '${{ inputs.version }}' '$APP_NAME' '$DEPLOY_PATH' '${{ inputs.environment }}'"
        echo "‚úÖ Atomic deployment completed"

    - name: Verify deployment
      shell: bash
      run: |
        echo "üîç Verifying deployment..."
        
        # Verify symlink
        ssh -p ${{ inputs.ssh-port }} \
          ${{ inputs.ssh-user }}@${{ inputs.ssh-host }} \
          "if [ -L ~/releases/${{ inputs.environment }}-current ]; then ls -la ~/releases/${{ inputs.environment }}-current && readlink ~/releases/${{ inputs.environment }}-current; else echo 'Symlink ~/releases/${{ inputs.environment }}-current does not exist'; fi"
        
        # Determine app name for PM2 verification
        if [ "${{ inputs.environment }}" = "staging" ]; then
          APP_NAME="drevo-staging"
        elif [ "${{ inputs.environment }}" = "production" ]; then
          APP_NAME="drevo-production"
        else
          echo "‚ùå Invalid environment: ${{ inputs.environment }}"
          exit 1
        fi
        
        # Verify PM2 status
        echo "üîç Verifying PM2 status..."
        ssh -p ${{ inputs.ssh-port }} \
          ${{ inputs.ssh-user }}@${{ inputs.ssh-host }} \
          "pm2 show $APP_NAME | head -10 || echo 'PM2 process not found or not running'"
        
        echo "‚úÖ Deployment verification completed"

    - name: Notify deployment success
      shell: bash
      run: |
        echo "‚úÖ ${{ inputs.environment }} deployment successful"
        if [ -n "${{ inputs.environment-url }}" ]; then
          echo "üåê URL: ${{ inputs.environment-url }}"
        fi
        echo "üéâ Release ${{ inputs.version }} is live!"